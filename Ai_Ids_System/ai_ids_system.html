<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ê¸°ë°˜ ìœ„í—˜ íŒ¨í„´ íƒì§€ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
        }

        .header p {
            color: #7f8c8d;
            text-align: center;
            font-size: 1.1em;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        .risk-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f39c12;
            animation: pulse 2s infinite;
        }

        .risk-indicator.high { background: #e74c3c; }
        .risk-indicator.medium { background: #f39c12; }
        .risk-indicator.low { background: #27ae60; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .file-upload {
            border: 2px dashed #e74c3c;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: rgba(231, 76, 60, 0.05);
        }

        .file-upload:hover {
            border-color: #c0392b;
            background: rgba(231, 76, 60, 0.1);
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .upload-btn {
            background: #e74c3c;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .analysis-section {
            grid-column: 1 / -1;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .risk-metric-card {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
        }

        .log-normal { background: rgba(46, 204, 113, 0.2); }
        .log-warning { background: rgba(241, 196, 15, 0.2); }
        .log-danger { background: rgba(231, 76, 60, 0.2); }
        .log-high-risk { background: rgba(231, 76, 60, 0.4); animation: blink 2s infinite; }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-simulation {
            background: #9b59b6;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .ai-analysis {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .ai-analysis h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-thinking {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .network-viz {
            width: 100%;
            height: 300px;
            background: #34495e;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .network-node {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #3498db;
            border-radius: 50%;
            animation: float 3s ease-in-out infinite;
        }

        .network-node.high-risk {
            background: #e74c3c;
            animation: blink 1s infinite;
            width: 15px;
            height: 15px;
        }

        .network-node.medium-risk {
            background: #f39c12;
            animation: pulse 2s infinite;
            width: 12px;
            height: 12px;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .api-key-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .pattern-status {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .similarity-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .similarity-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #f39c12, #e74c3c);
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›¡ï¸ AI ê¸°ë°˜ ìœ„í—˜ íŒ¨í„´ íƒì§€ ì‹œìŠ¤í…œ</h1>
            <p>CSV ìœ„í—˜ íŒ¨í„´ ê¸°ì¤€ì„  ëŒ€ë¹„ ì‹¤ì‹œê°„ íŠ¸ë˜í”½ ìœ ì‚¬ë„ ë¶„ì„ ë° ìœ„í—˜ íƒì§€</p>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2>
                    <span class="status-indicator" id="systemStatus"></span>
                    ì‹œìŠ¤í…œ ìƒíƒœ
                </h2>
                <div class="metrics">
                    <div class="metric-card">
                        <div class="metric-value" id="totalPackets">0</div>
                        <div class="metric-label">ì´ íŒ¨í‚· ìˆ˜</div>
                    </div>
                    <div class="risk-metric-card">
                        <div class="metric-value" id="riskMatches">0</div>
                        <div class="metric-label">ìœ„í—˜ íŒ¨í„´ ë§¤ì¹˜</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgSimilarity">0%</div>
                        <div class="metric-label">í‰ê·  ìœ ì‚¬ë„</div>
                    </div>
                </div>

                <div class="pattern-status">
                    <h4>ğŸ“Š í˜„ì¬ ìœ„í—˜ë„: <span id="currentRiskLevel">UNKNOWN</span></h4>
                    <div class="similarity-bar">
                        <div class="similarity-fill" id="similarityFill" style="width: 0%"></div>
                    </div>
                    <p style="margin-top: 5px; font-size: 12px;">CSV ìœ„í—˜ íŒ¨í„´ ê¸°ì¤€ì„  ëŒ€ë¹„ ì‹¤ì‹œê°„ íŠ¸ë˜í”½ ìœ ì‚¬ë„</p>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ¯ íŒ¨í„´ ë§¤ì¹­ ì‹œê°í™”</h2>
                <div class="network-viz" id="networkViz"></div>
                <p>ìœ„í—˜ íŒ¨í„´ ìœ ì‚¬ë„ì— ë”°ë¥¸ ì‹¤ì‹œê°„ ë„¤íŠ¸ì›Œí¬ ìƒíƒœ</p>
            </div>
        </div>

        <div class="card analysis-section">
            <h2>ğŸ¤– AI ìœ„í—˜ íŒ¨í„´ ë¶„ì„</h2>
            
            <div class="file-upload">
                <p>âš ï¸ ìœ„í—˜ íŒ¨í„´ ê¸°ì¤€ì„  ì—…ë¡œë“œ (CSV)</p>
                <input type="file" id="csvFile" accept=".csv" />
                <button class="upload-btn" onclick="document.getElementById('csvFile').click()">
                    ìœ„í—˜ íŒ¨í„´ íŒŒì¼ ì„ íƒ
                </button>
                <p style="margin-top: 10px; font-size: 12px; color: #666;">
                    ğŸš¨ CSV ë°ì´í„°ëŠ” ìœ„í—˜í•œ ê³µê²© íŒ¨í„´ì˜ ê¸°ì¤€ì„ ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤
                </p>
            </div>

            <div style="margin-bottom: 20px;">
                <input type="password" class="api-key-input" id="apiKey" placeholder="Google Gemini API í‚¤ ì…ë ¥" value="AIzaSyDPUXHrBZ3P4luxl9aTvrqsTPRZtDNAo18">
                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                    ğŸ¤– Gemini APIë¡œ ìœ„í—˜ íŒ¨í„´ ìœ ì‚¬ë„ ë¶„ì„ ë° ìœ„í—˜ë„ í‰ê°€
                </p>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="startPatternAnalysis()">ğŸ” ìœ„í—˜ íŒ¨í„´ ë¶„ì„</button>
                <button class="btn btn-success" onclick="startThreatMonitoring()">ğŸ“¡ ìœ„í—˜ ëª¨ë‹ˆí„°ë§</button>
                <button class="btn btn-danger" onclick="stopMonitoring()">â¹ï¸ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€</button>
                <button class="btn btn-simulation" onclick="startThreatSimulation()">ğŸ­ ìœ„í—˜ ì‹œë®¬ë ˆì´ì…˜</button>
                <button class="btn btn-primary" onclick="generateThreatPatterns()">âš ï¸ ìœ„í—˜ íŒ¨í„´ ìƒ˜í”Œ</button>
            </div>

            <div class="log-container" id="logContainer">
                <div class="log-entry log-normal">[2025-06-29 10:00:00] ìœ„í—˜ íŒ¨í„´ íƒì§€ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ</div>
                <div class="log-entry log-warning">[2025-06-29 10:00:01] ìœ„í—˜ íŒ¨í„´ ê¸°ì¤€ì„  ëŒ€ê¸° ì¤‘...</div>
                <div class="log-entry log-normal">[2025-06-29 10:00:02] AI íŒ¨í„´ ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜ ì¤€ë¹„ ì™„ë£Œ</div>
            </div>

            <div class="ai-analysis" id="aiAnalysis" style="display: none;">
                <h3>
                    <span class="ai-thinking">ğŸ¤–</span>
                    AI ìœ„í—˜ íŒ¨í„´ ë¶„ì„ ê²°ê³¼
                </h3>
                <div id="analysisResults">ìœ„í—˜ íŒ¨í„´ ë¶„ì„ ì§„í–‰ ì¤‘...</div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        var monitoringActive = false;
        var simulationActive = false;
        var threatBaseline = [];
        var realtimeTraffic = [];
        var simulationData = [];
        var totalPackets = 0;
        var riskMatches = 0;
        var currentRiskLevel = 'UNKNOWN';
        var averageSimilarity = 0;

        // íŒ¨í„´ ë§¤ì¹­ ê°€ì¤‘ì¹˜
        var WEIGHTS = {
            protocol: 0.30,
            port: 0.25,
            packetSize: 0.20,
            ipPattern: 0.15,
            attackType: 0.10
        };

        // ë„¤íŠ¸ì›Œí¬ ì‹œê°í™” ì´ˆê¸°í™”
        function initNetworkVisualization() {
            var container = document.getElementById('networkViz');
            for (var i = 0; i < 20; i++) {
                var node = document.createElement('div');
                node.className = 'network-node';
                node.style.left = Math.random() * 90 + '%';
                node.style.top = Math.random() * 90 + '%';
                node.style.animationDelay = Math.random() * 3 + 's';
                container.appendChild(node);
            }
        }

        // CSV íŒŒì¼ ì²˜ë¦¬
        function setupFileUpload() {
            document.getElementById('csvFile').addEventListener('change', function(e) {
                var file = e.target.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var csv = e.target.result;
                        parseThreatBaseline(csv);
                    };
                    reader.readAsText(file);
                }
            });
        }

        // CSV ìœ„í—˜ íŒ¨í„´ ê¸°ì¤€ì„  íŒŒì‹±
        function parseThreatBaseline(csv) {
            var lines = csv.split('\n');
            var data = [];

            for (var i = 0; i < lines.length; i++) {
                if (lines[i].trim()) {
                    var values = lines[i].split(',');
                    
                    if (values.length >= 3) {
                        var row = {
                            uid: values[0] || 'threat_' + i,
                            timestamp: values[1] || Date.now(),
                            protocol: values[2] || 'Unknown',
                            sourceIP: values[3] || '0.0.0.0',
                            destinationIP: values[4] || '0.0.0.0',
                            sourcePort: parseInt(values[5]) || 0,
                            destinationPort: parseInt(values[6]) || 0,
                            packetSize: parseInt(values[7]) || 500,
                            directionType: parseInt(values[8]) || 0,
                            eventCount: parseInt(values[9]) || 1,
                            attackType: detectThreatType(values[2], values[5], values[6], values[7]),
                            severity: 'HIGH',
                            patternSignature: generatePatternSignature(values),
                            dataType: 'threat_baseline'
                        };
                        data.push(row);
                    }
                }
            }

            threatBaseline = data;
            addLog('âš ï¸ ìœ„í—˜ íŒ¨í„´ ê¸°ì¤€ì„  ì„¤ì • ì™„ë£Œ (' + data.length + 'ê°œ ìœ„í—˜ íŒ¨í„´) - ì‹¤ì‹œê°„ ë¹„êµ ì¤€ë¹„ë¨', 'danger');
            updateSystemStatus('BASELINE_LOADED');
            updateMetrics();
        }

        // ìœ„í—˜ ìœ í˜• ê°ì§€
        function detectThreatType(protocol, sourcePort, destPort, packetSize) {
            var size = parseInt(packetSize) || 0;
            var dport = parseInt(destPort) || 0;
            
            if (protocol === 'TCP') {
                if (dport === 22) return 'SSH_BRUTE_FORCE';
                if (dport === 80 || dport === 443) return 'HTTP_FLOOD';
                if (size > 1400) return 'TCP_FLOOD';
                return 'TCP_SCAN';
            }
            
            if (protocol === 'LDAP') return 'LDAP_INJECTION';
            if (protocol === 'DNS') return size > 512 ? 'DNS_AMPLIFICATION' : 'DNS_TUNNEL';
            if (protocol === 'CDP') return 'CDP_FLOOD';
            if (protocol === 'ARP') return 'ARP_POISONING';
            
            return 'ADVANCED_THREAT';
        }

        // íŒ¨í„´ ì‹œê·¸ë‹ˆì²˜ ìƒì„±
        function generatePatternSignature(values) {
            return {
                protocol: values[2] || 'Unknown',
                portRange: categorizePort(parseInt(values[6]) || 0),
                sizeCategory: categorizePacketSize(parseInt(values[7]) || 0),
                ipClass: categorizeIP(values[3] || '0.0.0.0')
            };
        }

        // í¬íŠ¸ ë¶„ë¥˜
        function categorizePort(port) {
            if (port <= 1023) return 'SYSTEM';
            if (port <= 49151) return 'REGISTERED';
            return 'DYNAMIC';
        }

        // íŒ¨í‚· í¬ê¸° ë¶„ë¥˜
        function categorizePacketSize(size) {
            if (size < 100) return 'TINY';
            if (size < 500) return 'SMALL';
            if (size < 1500) return 'MEDIUM';
            return 'LARGE';
        }

        // IP ë¶„ë¥˜
        function categorizeIP(ip) {
            if (ip.startsWith('192.168.')) return 'PRIVATE_A';
            if (ip.startsWith('10.')) return 'PRIVATE_B';
            if (ip.startsWith('172.')) return 'PRIVATE_C';
            return 'PUBLIC';
        }

        // ìœ„í—˜ íŒ¨í„´ ìœ ì‚¬ë„ ê³„ì‚°
        function calculateThreatSimilarity(realtimeEvent, threatPattern) {
            var similarity = 0;
            
            // í”„ë¡œí† ì½œ ë§¤ì¹˜ (30%)
            if (realtimeEvent.protocol === threatPattern.protocol) {
                similarity += WEIGHTS.protocol;
            }
            
            // í¬íŠ¸ ìœ ì‚¬ì„± (25%)
            var realtimePortCategory = categorizePort(realtimeEvent.destinationPort);
            var threatPortCategory = categorizePort(threatPattern.destinationPort);
            if (realtimePortCategory === threatPortCategory) {
                similarity += WEIGHTS.port;
            }
            
            // íŒ¨í‚· í¬ê¸° ìœ ì‚¬ì„± (20%)
            var realtimeSizeCategory = categorizePacketSize(realtimeEvent.packetSize);
            var threatSizeCategory = categorizePacketSize(threatPattern.packetSize);
            if (realtimeSizeCategory === threatSizeCategory) {
                similarity += WEIGHTS.packetSize;
            }
            
            // IP íŒ¨í„´ ìœ ì‚¬ì„± (15%)
            var realtimeIPCategory = categorizeIP(realtimeEvent.sourceIP);
            var threatIPCategory = categorizeIP(threatPattern.sourceIP);
            if (realtimeIPCategory === threatIPCategory) {
                similarity += WEIGHTS.ipPattern;
            }
            
            // ê³µê²© ìœ í˜• ë§¤ì¹˜ (10%)
            if (realtimeEvent.attackType === threatPattern.attackType) {
                similarity += WEIGHTS.attackType;
            }
            
            return similarity;
        }

        // ìœ„í—˜ë„ í‰ê°€
        function assessRiskLevel(similarity) {
            if (similarity >= 0.70) return 'HIGH';
            if (similarity >= 0.50) return 'MEDIUM';
            return 'LOW';
        }

        // ìœ„í—˜ íŒ¨í„´ ë¶„ì„ ì‹œì‘
        function startPatternAnalysis() {
            if (threatBaseline.length === 0) {
                alert('ìœ„í—˜ íŒ¨í„´ ê¸°ì¤€ì„ ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. CSV íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (realtimeTraffic.length === 0 && simulationData.length === 0) {
                alert('ë¶„ì„í•  ì‹¤ì‹œê°„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„í—˜ ëª¨ë‹ˆí„°ë§ì´ë‚˜ ì‹œë®¬ë ˆì´ì…˜ì„ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }

            var apiKey = document.getElementById('apiKey').value;
            
            document.getElementById('aiAnalysis').style.display = 'block';
            document.getElementById('analysisResults').innerHTML = '<div class="loading"></div> AIê°€ ìœ„í—˜ íŒ¨í„´ ìœ ì‚¬ë„ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...';

            setTimeout(function() {
                try {
                    performThreatPatternAnalysis(apiKey);
                } catch (error) {
                    document.getElementById('analysisResults').innerHTML = 'âŒ ìœ„í—˜ íŒ¨í„´ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message;
                    addLog('ìœ„í—˜ íŒ¨í„´ ë¶„ì„ ì˜¤ë¥˜: ' + error.message, 'danger');
                }
            }, 2000);
        }

        // ìœ„í—˜ íŒ¨í„´ ë¶„ì„ ìˆ˜í–‰
        function performThreatPatternAnalysis(apiKey) {
            var threatAnalysis = analyzeAgainstBaseline();
            var prompt = generateThreatAnalysisPrompt(threatAnalysis);
            
            if (apiKey && apiKey.length > 20) {
                // í”„ë¡ì‹œë¥¼ í†µí•œ API í˜¸ì¶œ ì‹œë„
                callGeminiThroughProxy(apiKey, prompt).then(function(result) {
                    document.getElementById('analysisResults').innerHTML = result;
                    addLog('ğŸ¤– Gemini AI ìœ„í—˜ íŒ¨í„´ ë¶„ì„ ì™„ë£Œ', 'normal');
                }).catch(function(error) {
                    addLog('Gemini API ì‹¤íŒ¨, ë¡œì»¬ ë¶„ì„ìœ¼ë¡œ ì „í™˜', 'warning');
                    var localResult = performLocalThreatAnalysis(threatAnalysis);
                    document.getElementById('analysisResults').innerHTML = localResult;
                });
            } else {
                addLog('ë‚´ì¥ AIë¡œ ìœ„í—˜ íŒ¨í„´ ë¶„ì„ ìˆ˜í–‰', 'normal');
                var localResult = performLocalThreatAnalysis(threatAnalysis);
                document.getElementById('analysisResults').innerHTML = localResult;
            }
        }

        // í”„ë¡ì‹œë¥¼ í†µí•œ Gemini API í˜¸ì¶œ
        function callGeminiThroughProxy(apiKey, prompt) {
            var proxyUrls = [
                'https://api.allorigins.win/get?url=',
                'https://cors-anywhere.herokuapp.com/',
                'https://proxy.cors.sh/'
            ];
            
            var geminiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + apiKey;
            
            return new Promise(function(resolve, reject) {
                var tryProxy = function(proxyIndex) {
                    if (proxyIndex >= proxyUrls.length) {
                        // ëª¨ë“  í”„ë¡ì‹œ ì‹¤íŒ¨ ì‹œ ì§ì ‘ í˜¸ì¶œ ì‹œë„
                        return callGeminiDirectly(apiKey, prompt).then(resolve).catch(reject);
                    }
                    
                    var proxyUrl = proxyUrls[proxyIndex] + encodeURIComponent(geminiUrl);
                    
                    fetch(proxyUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    }).then(function(response) {
                        if (response.ok) {
                            return response.json().then(function(data) {
                                var actualData = JSON.parse(data.contents || data);
                                if (actualData.candidates && actualData.candidates[0]) {
                                    resolve(formatThreatAnalysisResult(actualData.candidates[0].content.parts[0].text));
                                } else {
                                    throw new Error('Invalid response format');
                                }
                            });
                        } else {
                            throw new Error('Proxy failed');
                        }
                    }).catch(function() {
                        tryProxy(proxyIndex + 1);
                    });
                };
                
                tryProxy(0);
            });
        }

        // ì§ì ‘ Gemini API í˜¸ì¶œ
        function callGeminiDirectly(apiKey, prompt) {
            return fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + apiKey, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            }).then(function(response) {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Direct API call failed');
                }
            }).then(function(data) {
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    return formatThreatAnalysisResult(data.candidates[0].content.parts[0].text);
                } else {
                    throw new Error('Invalid API response');
                }
            });
        }

        // ê¸°ì¤€ì„  ëŒ€ë¹„ ë¶„ì„
        function analyzeAgainstBaseline() {
            var analysis = {
                totalRealtimeEvents: realtimeTraffic.length,
                totalSimulationEvents: simulationData.length,
                highRiskMatches: [],
                mediumRiskMatches: [],
                lowRiskMatches: [],
                averageSimilarity: 0,
                maxSimilarity: 0,
                riskDistribution: { HIGH: 0, MEDIUM: 0, LOW: 0 }
            };

            var allEvents = realtimeTraffic.concat(simulationData);
            var totalSimilarity = 0;

            for (var i = 0; i < allEvents.length; i++) {
                var event = allEvents[i];
                var maxEventSimilarity = 0;
                var bestMatch = null;

                for (var j = 0; j < threatBaseline.length; j++) {
                    var similarity = calculateThreatSimilarity(event, threatBaseline[j]);
                    if (similarity > maxEventSimilarity) {
                        maxEventSimilarity = similarity;
                        bestMatch = threatBaseline[j];
                    }
                }

                var riskLevel = assessRiskLevel(maxEventSimilarity);
                var match = {
                    event: event,
                    similarity: maxEventSimilarity,
                    riskLevel: riskLevel,
                    matchedPattern: bestMatch
                };

                if (riskLevel === 'HIGH') {
                    analysis.highRiskMatches.push(match);
                    analysis.riskDistribution.HIGH++;
                } else if (riskLevel === 'MEDIUM') {
                    analysis.mediumRiskMatches.push(match);
                    analysis.riskDistribution.MEDIUM++;
                } else {
                    analysis.lowRiskMatches.push(match);
                    analysis.riskDistribution.LOW++;
                }

                totalSimilarity += maxEventSimilarity;
                if (maxEventSimilarity > analysis.maxSimilarity) {
                    analysis.maxSimilarity = maxEventSimilarity;
                }
            }

            analysis.averageSimilarity = allEvents.length > 0 ? totalSimilarity / allEvents.length : 0;
            return analysis;
        }

        // ìœ„í—˜ ë¶„ì„ í”„ë¡¬í”„íŠ¸ ìƒì„±
        function generateThreatAnalysisPrompt(analysis) {
            var prompt = "ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ ì „ë¬¸ê°€ë¡œì„œ ë‹¤ìŒ ìœ„í—˜ íŒ¨í„´ ë¶„ì„ ê²°ê³¼ë¥¼ í‰ê°€í•˜ê³  í•œêµ­ì–´ë¡œ ìƒì„¸í•œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:\n\n";
            
            prompt += "=== ìœ„í—˜ íŒ¨í„´ ê¸°ì¤€ì„  ì •ë³´ ===\n";
            prompt += "- ë“±ë¡ëœ ìœ„í—˜ íŒ¨í„´: " + threatBaseline.length + "ê°œ\n";
            prompt += "- íŒ¨í„´ ìœ í˜•: ê³ ìœ„í—˜ ê³µê²© ì‹œê·¸ë‹ˆì²˜\n\n";
            
            prompt += "=== ì‹¤ì‹œê°„ íŠ¸ë˜í”½ ë¶„ì„ ê²°ê³¼ ===\n";
            prompt += "- ë¶„ì„ëœ ì´ë²¤íŠ¸: " + (analysis.totalRealtimeEvents + analysis.totalSimulationEvents) + "ê°œ\n";
            prompt += "- í‰ê·  ìœ ì‚¬ë„: " + (analysis.averageSimilarity * 100).toFixed(1) + "%\n";
            prompt += "- ìµœëŒ€ ìœ ì‚¬ë„: " + (analysis.maxSimilarity * 100).toFixed(1) + "%\n\n";
            
            prompt += "=== ìœ„í—˜ë„ë³„ ë§¤ì¹­ ê²°ê³¼ ===\n";
            prompt += "- HIGH RISK (70% ì´ìƒ): " + analysis.riskDistribution.HIGH + "ê±´\n";
            prompt += "- MEDIUM RISK (50-69%): " + analysis.riskDistribution.MEDIUM + "ê±´\n";
            prompt += "- LOW RISK (50% ë¯¸ë§Œ): " + analysis.riskDistribution.LOW + "ê±´\n\n";
            
            if (analysis.highRiskMatches.length > 0) {
                prompt += "=== ê³ ìœ„í—˜ íŒ¨í„´ ë§¤ì¹˜ ìƒì„¸ ===\n";
                for (var i = 0; i < Math.min(5, analysis.highRiskMatches.length); i++) {
                    var match = analysis.highRiskMatches[i];
                    prompt += "- ìœ ì‚¬ë„ " + (match.similarity * 100).toFixed(1) + "%: " + match.event.attackType + " (" + match.event.sourceIP + ")\n";
                }
                prompt += "\n";
            }
            
            prompt += "ë‹¤ìŒ í•­ëª©ë“¤ì„ í¬í•¨í•œ ìœ„í—˜ í‰ê°€ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:\n";
            prompt += "1. í˜„ì¬ ë„¤íŠ¸ì›Œí¬ì˜ ì „ë°˜ì ì¸ ìœ„í—˜ ìƒíƒœ í‰ê°€\n";
            prompt += "2. ê³ ìœ„í—˜ íŒ¨í„´ ë§¤ì¹˜ì— ëŒ€í•œ ìƒì„¸ ë¶„ì„\n";
            prompt += "3. ìœ„í—˜ íŒ¨í„´ ìœ ì‚¬ë„ê°€ ë†’ì€ íŠ¸ë˜í”½ì˜ ìœ„í—˜ì„± í‰ê°€\n";
            prompt += "4. ì¦‰ì‹œ ì ìš©í•´ì•¼ í•  ë³´ì•ˆ ì¡°ì¹˜ì‚¬í•­\n";
            prompt += "5. ì§€ì†ì ì¸ ìœ„í—˜ íŒ¨í„´ ëª¨ë‹ˆí„°ë§ ì „ëµ\n";
            prompt += "6. ê³µê²© íŒ¨í„´ ì§„í™”ì— ëŒ€ë¹„í•œ ëŒ€ì‘ ë°©ì•ˆ\n\n";
            prompt += "ì‹¤ë¬´ì§„ì´ ì¦‰ì‹œ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë‚´ìš©ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.";
            
            return prompt;
        }

        // ë¡œì»¬ ìœ„í—˜ ë¶„ì„
        function performLocalThreatAnalysis(analysis) {
            var report = '<div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">';
            report += '<h3>ğŸš¨ ìœ„í—˜ íŒ¨í„´ ë¶„ì„ ë³´ê³ ì„œ</h3>';
            report += '<p>CSV ê¸°ì¤€ì„  ëŒ€ë¹„ ì‹¤ì‹œê°„ íŠ¸ë˜í”½ ìœ„í—˜ë„ í‰ê°€</p>';
            report += '</div>';
            
            // ì „ë°˜ì ì¸ ìœ„í—˜ ìƒíƒœ
            var overallRisk = 'LOW';
            if (analysis.riskDistribution.HIGH > 0 || analysis.averageSimilarity > 0.6) {
                overallRisk = 'HIGH';
            } else if (analysis.riskDistribution.MEDIUM > 5 || analysis.averageSimilarity > 0.4) {
                overallRisk = 'MEDIUM';
            }
            
            report += '<h4 style="color: #fff; margin: 15px 0 10px 0;">ğŸ¯ ì „ë°˜ì ì¸ ìœ„í—˜ ìƒíƒœ</h4>';
            report += '<div style="margin-left: 20px; background: rgba(231, 76, 60, 0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
            report += 'â€¢ <strong>í˜„ì¬ ìœ„í—˜ë„: ' + overallRisk + '</strong><br>';
            report += 'â€¢ í‰ê·  íŒ¨í„´ ìœ ì‚¬ë„: ' + (analysis.averageSimilarity * 100).toFixed(1) + '%<br>';
            report += 'â€¢ ìµœëŒ€ ìœ„í—˜ ìœ ì‚¬ë„: ' + (analysis.maxSimilarity * 100).toFixed(1) + '%<br>';
            report += 'â€¢ ë¶„ì„ëœ ì´ ì´ë²¤íŠ¸: ' + (analysis.totalRealtimeEvents + analysis.totalSimulationEvents) + 'ê±´';
            report += '</div>';
            
            // ìœ„í—˜ë„ë³„ ë¶„í¬
            report += '<h4 style="color: #fff; margin: 15px 0 10px 0;">ğŸ“Š ìœ„í—˜ íŒ¨í„´ ë§¤ì¹­ ë¶„í¬</h4>';
            report += '<div style="margin-left: 20px; background: rgba(52, 152, 219, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
            report += 'ğŸ”´ <strong>HIGH RISK (70% ì´ìƒ):</strong> ' + analysis.riskDistribution.HIGH + 'ê±´<br>';
            report += 'ğŸŸ¡ <strong>MEDIUM RISK (50-69%):</strong> ' + analysis.riskDistribution.MEDIUM + 'ê±´<br>';
            report += 'ğŸŸ¢ <strong>LOW RISK (50% ë¯¸ë§Œ):</strong> ' + analysis.riskDistribution.LOW + 'ê±´';
            report += '</div>';
            
            // ê³ ìœ„í—˜ íŒ¨í„´ ìƒì„¸
            if (analysis.highRiskMatches.length > 0) {
                report += '<h4 style="color: #fff; margin: 15px 0 10px 0;">ğŸš¨ ê³ ìœ„í—˜ íŒ¨í„´ ë§¤ì¹˜ ìƒì„¸</h4>';
                report += '<div style="margin-left: 20px; background: rgba(231, 76, 60, 0.4); padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
                for (var i = 0; i < Math.min(5, analysis.highRiskMatches.length); i++) {
                    var match = analysis.highRiskMatches[i];
                    report += 'âš ï¸ <strong>ìœ ì‚¬ë„ ' + (match.similarity * 100).toFixed(1) + '%:</strong> ' + match.event.attackType + '<br>';
                    report += '&nbsp;&nbsp;&nbsp;ì¶œë°œì§€: ' + match.event.sourceIP + ' â†’ ëª©ì ì§€: ' + match.event.destinationIP + '<br>';
                }
                if (analysis.highRiskMatches.length > 5) {
                    report += '&nbsp;&nbsp;&nbsp;... ì¶”ê°€ ' + (analysis.highRiskMatches.length - 5) + 'ê±´ì˜ ê³ ìœ„í—˜ ë§¤ì¹˜<br>';
                }
                report += '</div>';
            }
            
            // ì¦‰ì‹œ ì¡°ì¹˜ì‚¬í•­
            report += '<h4 style="color: #fff; margin: 15px 0 10px 0;">âš¡ ì¦‰ì‹œ ì¡°ì¹˜ì‚¬í•­</h4>';
            report += '<div style="margin-left: 20px;">';
            
            if (analysis.riskDistribution.HIGH > 0) {
                report += 'ğŸš¨ <strong>ê¸´ê¸‰ ëŒ€ì‘:</strong><br>';
                report += '&nbsp;&nbsp;â€¢ ê³ ìœ„í—˜ IP ì£¼ì†Œ ì¦‰ì‹œ ì°¨ë‹¨<br>';
                report += '&nbsp;&nbsp;â€¢ ë³´ì•ˆíŒ€ ê¸´ê¸‰ ì†Œì§‘ ë° ìƒí™© ê³µìœ <br>';
                report += '&nbsp;&nbsp;â€¢ ì‹œìŠ¤í…œ ë¡œê·¸ ìƒì„¸ ë¶„ì„ ì‹¤ì‹œ<br>';
            }
            
            if (analysis.averageSimilarity > 0.4) {
                report += 'âš ï¸ <strong>ì£¼ì˜ ëª¨ë‹ˆí„°ë§:</strong><br>';
                report += '&nbsp;&nbsp;â€¢ ì‹¤ì‹œê°„ ì•Œë¦¼ ì‹œìŠ¤í…œ ê°•í™”<br>';
                report += '&nbsp;&nbsp;â€¢ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ìƒì„¸ ê°ì‹œ<br>';
                report += '&nbsp;&nbsp;â€¢ ì¶”ê°€ ìœ„í—˜ íŒ¨í„´ ë°œê²¬ ì‹œ ì¦‰ì‹œ ë³´ê³ <br>';
            }
            
            report += 'ğŸ“‹ <strong>ì§€ì†ì ì¸ ë³´ì•ˆ ê°•í™”:</strong><br>';
            report += '&nbsp;&nbsp;â€¢ ìœ„í—˜ íŒ¨í„´ ë°ì´í„°ë² ì´ìŠ¤ ì •ê¸° ì—…ë°ì´íŠ¸<br>';
            report += '&nbsp;&nbsp;â€¢ AI ëª¨ë¸ ì¬í•™ìŠµì„ í†µí•œ íƒì§€ ì •í™•ë„ í–¥ìƒ<br>';
            report += '&nbsp;&nbsp;â€¢ ë‹¤ê³„ì¸µ ë³´ì•ˆ ì•„í‚¤í…ì²˜ êµ¬ì¶•<br>';
            report += '&nbsp;&nbsp;â€¢ ì •ê¸°ì ì¸ ë³´ì•ˆ ì·¨ì•½ì  ì ê²€ ë° íŒ¨ì¹˜';
            report += '</div>';
            
            return report;
        }

        // ìœ„í—˜ ë¶„ì„ ê²°ê³¼ í¬ë§·íŒ…
        function formatThreatAnalysisResult(text) {
            return text
                .replace(/## (.*)/g, '<h4 style="color: #fff; margin: 15px 0 10px 0;">$1</h4>')
                .replace(/### (.*)/g, '<h5 style="color: #ecf0f1; margin: 10px 0 8px 0;">$1</h5>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>')
                .replace(/- (.*)/g, '<div style="margin-left: 20px;">â€¢ $1</div>');
        }

        // ìœ„í—˜ ëª¨ë‹ˆí„°ë§ ì‹œì‘
        function startThreatMonitoring() {
            if (threatBaseline.length === 0) {
                alert('ìœ„í—˜ íŒ¨í„´ ê¸°ì¤€ì„ ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. CSV íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (monitoringActive) return;
            
            monitoringActive = true;
            realtimeTraffic = [];
            addLog('ğŸ”´ ìœ„í—˜ íŒ¨í„´ ëª¨ë‹ˆí„°ë§ ì‹œì‘ - ì‹¤ì‹œê°„ íŠ¸ë˜í”½ì„ ìœ„í—˜ ê¸°ì¤€ì„ ê³¼ ë¹„êµ ì¤‘', 'danger');
            updateSystemStatus('MONITORING');
            
            var monitoringInterval = setInterval(function() {
                if (!monitoringActive) {
                    clearInterval(monitoringInterval);
                    return;
                }
                
                // ì‹¤ì‹œê°„ íŠ¸ë˜í”½ ìƒì„± (ì •ìƒ 80%, ì˜ì‹¬ 20%)
                var event = generateRealtimeTrafficEvent();
                realtimeTraffic.push(event);
                
                // ìœ„í—˜ íŒ¨í„´ê³¼ ë¹„êµ
                var maxSimilarity = 0;
                var bestMatch = null;
                
                for (var i = 0; i < threatBaseline.length; i++) {
                    var similarity = calculateThreatSimilarity(event, threatBaseline[i]);
                    if (similarity > maxSimilarity) {
                        maxSimilarity = similarity;
                        bestMatch = threatBaseline[i];
                    }
                }
                
                var riskLevel = assessRiskLevel(maxSimilarity);
                var timestamp = new Date().toLocaleTimeString();
                totalPackets++;
                
                // ìœ„í—˜ë„ì— ë”°ë¥¸ ì²˜ë¦¬
                if (riskLevel === 'HIGH') {
                    riskMatches++;
                    addLog('[' + timestamp + '] ğŸš¨ HIGH RISK: ' + event.attackType + ' (ìœ ì‚¬ë„ ' + (maxSimilarity * 100).toFixed(1) + '%) - ' + event.sourceIP, 'high-risk');
                    
                    // ë„¤íŠ¸ì›Œí¬ ì‹œê°í™” ì—…ë°ì´íŠ¸
                    updateNetworkNode('high-risk');
                    
                } else if (riskLevel === 'MEDIUM') {
                    riskMatches++;
                    addLog('[' + timestamp + '] âš ï¸ MEDIUM RISK: ' + event.attackType + ' (ìœ ì‚¬ë„ ' + (maxSimilarity * 100).toFixed(1) + '%) - ' + event.sourceIP, 'warning');
                    updateNetworkNode('medium-risk');
                    
                } else {
                    addLog('[' + timestamp + '] âœ… LOW RISK: ' + event.attackType + ' (ìœ ì‚¬ë„ ' + (maxSimilarity * 100).toFixed(1) + '%)', 'normal');
                }
                
                // ì „ì²´ í‰ê·  ìœ ì‚¬ë„ ì—…ë°ì´íŠ¸
                updateAverageSimilarity();
                updateCurrentRiskLevel(riskLevel);
                updateMetrics();
                
                // ë°ì´í„° í¬ê¸° ì œí•œ
                if (realtimeTraffic.length > 100) {
                    realtimeTraffic = realtimeTraffic.slice(-50);
                }
                
            }, 2000);
        }

        // ì‹¤ì‹œê°„ íŠ¸ë˜í”½ ì´ë²¤íŠ¸ ìƒì„±
        function generateRealtimeTrafficEvent() {
            var eventTypes = [
                // ì •ìƒ íŠ¸ë˜í”½ (80%)
                { type: 'HTTP_REQUEST', protocol: 'HTTP', port: 80, size: 500, threat: false, weight: 25 },
                { type: 'HTTPS_REQUEST', protocol: 'HTTPS', port: 443, size: 600, threat: false, weight: 25 },
                { type: 'DNS_QUERY', protocol: 'DNS', port: 53, size: 100, threat: false, weight: 15 },
                { type: 'SSH_LOGIN', protocol: 'SSH', port: 22, size: 200, threat: false, weight: 10 },
                { type: 'EMAIL_TRANSFER', protocol: 'SMTP', port: 25, size: 800, threat: false, weight: 5 },
                
                // ì˜ì‹¬ íŠ¸ë˜í”½ (20%)
                { type: 'PORT_SCAN', protocol: 'TCP', port: 80, size: 100, threat: true, weight: 8 },
                { type: 'BRUTE_FORCE', protocol: 'SSH', port: 22, size: 150, threat: true, weight: 5 },
                { type: 'DDoS_ATTEMPT', protocol: 'TCP', port: 80, size: 1500, threat: true, weight: 4 },
                { type: 'MALWARE_C2', protocol: 'HTTPS', port: 443, size: 2000, threat: true, weight: 3 }
            ];
            
            // ê°€ì¤‘ì¹˜ ê¸°ë°˜ ì„ íƒ
            var totalWeight = eventTypes.reduce(function(sum, e) { return sum + e.weight; }, 0);
            var random = Math.random() * totalWeight;
            var currentWeight = 0;
            var selectedEvent;
            
            for (var i = 0; i < eventTypes.length; i++) {
                currentWeight += eventTypes[i].weight;
                if (random <= currentWeight) {
                    selectedEvent = eventTypes[i];
                    break;
                }
            }
            
            return {
                uid: 'realtime_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                timestamp: Date.now(),
                protocol: selectedEvent.protocol,
                sourceIP: generateVariedIP(),
                destinationIP: '192.168.1.' + (Math.floor(Math.random() * 100) + 1),
                sourcePort: Math.floor(Math.random() * 65535),
                destinationPort: selectedEvent.port + Math.floor(Math.random() * 10),
                packetSize: selectedEvent.size + Math.floor(Math.random() * 200),
                directionType: Math.random() > 0.5 ? 0 : 1,
                eventCount: Math.floor(Math.random() * 50) + 1,
                attackType: selectedEvent.type,
                severity: selectedEvent.threat ? 'HIGH' : 'LOW',
                dataType: 'realtime'
            };
        }

        // ë‹¤ì–‘í•œ IP ìƒì„±
        function generateVariedIP() {
            var ipTypes = [
                // ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ (60%)
                '192.168.1.' + (Math.floor(Math.random() * 254) + 1),
                '192.168.0.' + (Math.floor(Math.random() * 254) + 1),
                '10.0.0.' + (Math.floor(Math.random() * 254) + 1),
                
                // ì™¸ë¶€ IP (40%)
                '203.0.113.' + (Math.floor(Math.random() * 254) + 1),
                '198.51.100.' + (Math.floor(Math.random() * 254) + 1),
                '185.220.101.' + (Math.floor(Math.random() * 254) + 1)
            ];
            
            return ipTypes[Math.floor(Math.random() * ipTypes.length)];
        }

        // ìœ„í—˜ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
        function startThreatSimulation() {
            if (threatBaseline.length === 0) {
                alert('ìœ„í—˜ íŒ¨í„´ ê¸°ì¤€ì„ ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. CSV íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (simulationActive) return;
            
            simulationActive = true;
            simulationData = [];
            addLog('ğŸ­ ìœ„í—˜ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ - ê³ ìœ„í—˜ íŒ¨í„´ê³¼ ìœ ì‚¬í•œ ê³µê²© íŠ¸ë˜í”½ ìƒì„±', 'danger');
            
            var attackCount = 0;
            var simulationInterval = setInterval(function() {
                if (attackCount >= 15 || !simulationActive) {
                    clearInterval(simulationInterval);
                    simulationActive = false;
                    addLog('ğŸ­ ìœ„í—˜ ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ - ì´ ' + simulationData.length + 'ê°œ ì‹œë®¬ë ˆì´ì…˜ ê³µê²© ìƒì„±', 'warning');
                    return;
                }
                
                // ê¸°ì¤€ì„ ê³¼ ìœ ì‚¬í•œ ê³ ìœ„í—˜ ì´ë²¤íŠ¸ ìƒì„±
                var simulatedAttack = generateHighRiskEvent();
                simulationData.push(simulatedAttack);
                
                // ê¸°ì¤€ì„ ê³¼ ìœ ì‚¬ë„ ê³„ì‚°
                var maxSimilarity = 0;
                for (var i = 0; i < threatBaseline.length; i++) {
                    var similarity = calculateThreatSimilarity(simulatedAttack, threatBaseline[i]);
                    if (similarity > maxSimilarity) {
                        maxSimilarity = similarity;
                    }
                }
                
                var timestamp = new Date().toLocaleTimeString();
                totalPackets++;
                riskMatches++;
                
                var riskLevel = assessRiskLevel(maxSimilarity);
                addLog('[' + timestamp + '] ğŸš¨ ì‹œë®¬ë ˆì´ì…˜ ' + riskLevel + ' RISK: ' + simulatedAttack.attackType + ' (ìœ ì‚¬ë„ ' + (maxSimilarity * 100).toFixed(1) + '%)', 'high-risk');
                
                updateNetworkNode(riskLevel.toLowerCase() + '-risk');
                updateMetrics();
                attackCount++;
                
            }, 1500);
        }

        // ê³ ìœ„í—˜ ì´ë²¤íŠ¸ ìƒì„± (ê¸°ì¤€ì„ ê³¼ ìœ ì‚¬í•˜ê²Œ)
        function generateHighRiskEvent() {
            var highRiskPatterns = [
                { type: 'ADVANCED_PERSISTENT_THREAT', protocol: 'TCP', port: 443, size: 2048 },
                { type: 'SQL_INJECTION', protocol: 'HTTP', port: 80, size: 1200 },
                { type: 'RANSOMWARE_C2', protocol: 'HTTPS', port: 8080, size: 1500 },
                { type: 'ZERO_DAY_EXPLOIT', protocol: 'TCP', port: 445, size: 3000 },
                { type: 'LATERAL_MOVEMENT', protocol: 'SMB', port: 445, size: 800 },
                { type: 'DATA_EXFILTRATION', protocol: 'HTTPS', port: 443, size: 4096 },
                { type: 'CRYPTOMINING_MALWARE', protocol: 'TCP', port: 4444, size: 600 },
                { type: 'PHISHING_CAMPAIGN', protocol: 'HTTP', port: 80, size: 1000 }
            ];
            
            var pattern = highRiskPatterns[Math.floor(Math.random() * highRiskPatterns.length)];
            var maliciousIPs = ['203.0.113.666', '198.51.100.999', '185.220.101.777'];
            
            return {
                uid: 'sim_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                timestamp: Date.now(),
                protocol: pattern.protocol,
                sourceIP: maliciousIPs[Math.floor(Math.random() * maliciousIPs.length)],
                destinationIP: '192.168.1.' + (Math.floor(Math.random() * 100) + 1),
                sourcePort: Math.floor(Math.random() * 65535),
                destinationPort: pattern.port,
                packetSize: pattern.size + Math.floor(Math.random() * 500),
                directionType: 0,
                eventCount: Math.floor(Math.random() * 500) + 100,
                attackType: pattern.type,
                severity: 'CRITICAL',
                dataType: 'simulation'
            };
        }

        // ìœ„í—˜ íŒ¨í„´ ìƒ˜í”Œ ìƒì„±
        function generateThreatPatterns() {
            var samplePatterns = [
                {
                    uid: 'threat_001',
                    protocol: 'TCP',
                    sourceIP: '203.0.113.666',
                    destinationIP: '192.168.1.100',
                    sourcePort: 12345,
                    destinationPort: 80,
                    packetSize: 1500,
                    directionType: 0,
                    eventCount: 200,
                    attackType: 'HTTP_FLOOD',
                    severity: 'HIGH',
                    dataType: 'threat_baseline'
                },
                {
                    uid: 'threat_002',
                    protocol: 'SSH',
                    sourceIP: '198.51.100.999',
                    destinationIP: '192.168.1.50',
                    sourcePort: 54321,
                    destinationPort: 22,
                    packetSize: 150,
                    directionType: 0,
                    eventCount: 500,
                    attackType: 'SSH_BRUTE_FORCE',
                    severity: 'CRITICAL',
                    dataType: 'threat_baseline'
                },
                {
                    uid: 'threat_003',
                    protocol: 'HTTPS',
                    sourceIP: '185.220.101.777',
                    destinationIP: '192.168.1.200',
                    sourcePort: 443,
                    destinationPort: 443,
                    packetSize: 2048,
                    directionType: 1,
                    eventCount: 300,
                    attackType: 'MALWARE_C2',
                    severity: 'HIGH',
                    dataType: 'threat_baseline'
                }
            ];

            threatBaseline = samplePatterns;
            addLog('âš ï¸ ìœ„í—˜ íŒ¨í„´ ìƒ˜í”Œ ìƒì„± ì™„ë£Œ (' + samplePatterns.length + 'ê°œ ê³ ìœ„í—˜ íŒ¨í„´)', 'danger');
            updateSystemStatus('BASELINE_LOADED');
            updateMetrics();
        }

        // ì‹œìŠ¤í…œ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSystemStatus(status) {
            var indicator = document.getElementById('systemStatus');
            var riskIndicator = document.querySelector('.risk-indicator');
            
            switch(status) {
                case 'BASELINE_LOADED':
                    indicator.style.background = '#f39c12';
                    indicator.className = 'risk-indicator medium';
                    break;
                case 'MONITORING':
                    indicator.style.background = '#e74c3c';
                    indicator.className = 'risk-indicator high';
                    break;
                default:
                    indicator.style.background = '#27ae60';
                    indicator.className = 'status-indicator';
            }
        }

        // í‰ê·  ìœ ì‚¬ë„ ì—…ë°ì´íŠ¸
        function updateAverageSimilarity() {
            var allEvents = realtimeTraffic.concat(simulationData);
            if (allEvents.length === 0) return;
            
            var totalSimilarity = 0;
            var eventCount = 0;
            
            for (var i = 0; i < allEvents.length; i++) {
                var event = allEvents[i];
                var maxSimilarity = 0;
                
                for (var j = 0; j < threatBaseline.length; j++) {
                    var similarity = calculateThreatSimilarity(event, threatBaseline[j]);
                    if (similarity > maxSimilarity) {
                        maxSimilarity = similarity;
                    }
                }
                
                totalSimilarity += maxSimilarity;
                eventCount++;
            }
            
            averageSimilarity = eventCount > 0 ? totalSimilarity / eventCount : 0;
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('avgSimilarity').textContent = (averageSimilarity * 100).toFixed(1) + '%';
            document.getElementById('similarityFill').style.width = (averageSimilarity * 100) + '%';
        }

        // í˜„ì¬ ìœ„í—˜ë„ ì—…ë°ì´íŠ¸
        function updateCurrentRiskLevel(latestRiskLevel) {
            currentRiskLevel = latestRiskLevel;
            var riskElement = document.getElementById('currentRiskLevel');
            
            switch(latestRiskLevel) {
                case 'HIGH':
                    riskElement.textContent = 'HIGH RISK';
                    riskElement.style.color = '#e74c3c';
                    break;
                case 'MEDIUM':
                    riskElement.textContent = 'MEDIUM RISK';
                    riskElement.style.color = '#f39c12';
                    break;
                case 'LOW':
                    riskElement.textContent = 'LOW RISK';
                    riskElement.style.color = '#27ae60';
                    break;
                default:
                    riskElement.textContent = 'UNKNOWN';
                    riskElement.style.color = '#95a5a6';
            }
        }

        // ë„¤íŠ¸ì›Œí¬ ë…¸ë“œ ì—…ë°ì´íŠ¸
        function updateNetworkNode(riskClass) {
            var nodes = document.querySelectorAll('.network-node');
            var randomNode = nodes[Math.floor(Math.random() * nodes.length)];
            
            // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
            randomNode.classList.remove('high-risk', 'medium-risk', 'low-risk');
            
            // ìƒˆ ìœ„í—˜ë„ í´ë˜ìŠ¤ ì¶”ê°€
            randomNode.classList.add(riskClass);
            
            // ì¼ì • ì‹œê°„ í›„ ì›ë˜ëŒ€ë¡œ ë³µì›
            setTimeout(function() {
                randomNode.classList.remove(riskClass);
            }, riskClass === 'high-risk' ? 8000 : 5000);
        }

        // ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
        function stopMonitoring() {
            monitoringActive = false;
            simulationActive = false;
            addLog('â¹ï¸ ìœ„í—˜ íŒ¨í„´ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ (ì‹¤ì‹œê°„: ' + realtimeTraffic.length + 'ê±´, ì‹œë®¬ë ˆì´ì…˜: ' + simulationData.length + 'ê±´)', 'warning');
            updateSystemStatus('STOPPED');
        }

        // ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
        function updateMetrics() {
            document.getElementById('totalPackets').textContent = totalPackets.toLocaleString();
            document.getElementById('riskMatches').textContent = riskMatches.toLocaleString();
        }

        // ë¡œê·¸ ì¶”ê°€
        function addLog(message, type) {
            type = type || 'normal';
            var logContainer = document.getElementById('logContainer');
            var logEntry = document.createElement('div');
            logEntry.className = 'log-entry log-' + type;
            logEntry.textContent = message;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            var logs = logContainer.querySelectorAll('.log-entry');
            if (logs.length > 50) {
                logs[0].remove();
            }
        }

        // ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initNetworkVisualization();
            setupFileUpload();
            addLog('ğŸ›¡ï¸ AI ê¸°ë°˜ ìœ„í—˜ íŒ¨í„´ íƒì§€ ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.', 'normal');
            addLog('âš ï¸ CSV íŒŒì¼ë¡œ ìœ„í—˜ íŒ¨í„´ ê¸°ì¤€ì„ ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.', 'warning');
        });
    </script>
</body>
</html>